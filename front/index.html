<!DOCTYPE html>
<html>

<head>
  <title>Socket.IO chat</title>
  <link rel="stylesheet" type="text/css" href="/static/style.css" />
</head>

<body>
  <header id="group">
    <div>Chat maroto do orkut</div>
    <ul id="members"></ul>
  </header>
  <ul id="messages"></ul>
  <p id="typing"></p>
  <form id="form" action="">
    <input id="input" autocomplete="off" />
    <select id="select" name="select"></select>
    <button>Send</button>
  </form>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const nick = Object.fromEntries(new URLSearchParams(window.location.search)).nick
    var socket = io.connect({ query: `loggeduser=${nick}` });

    var members = document.getElementById('members')
    var messages = document.getElementById('messages');
    var form = document.getElementById('form');
    var input = document.getElementById('input');
    var online = document.getElementById('select')

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      if (input.value) {
        const msg = {
          nick: nick,
          data: input.value,
          time: `${new Date().getHours()}:${new Date().getMinutes()}`
        }
        socket.emit('chat', msg);
        input.value = '';
        const d = new Date();

        socket.emit('typing', { nick, typing: false });
      }
    });

    form.addEventListener('input', function (e) {
      const typing = input.value ? true : false;
      const msg = {
        nick,
        typing,
      }
      socket.emit('typing', msg);
    });

    socket.on('chat', (msg) => {
      var item = document.createElement('li');
      var name = document.createElement('div');
      var time = document.createElement('div');
      var message = document.createElement('div');
      item.className = nick === msg.nick ? `my__message` : `others__message`;
      name.textContent = msg.nick;
      name.className = 'nick'
      time.textContent = msg.time;
      time.className = 'time'
      message.textContent = msg.data;
      message.className = 'message'
      item.appendChild(name)
      item.appendChild(time)
      item.appendChild(message)
      messages.appendChild(item);
      window.scrollTo(0, document.body.scrollHeight);
    });

    socket.on('members', (msg) => {
      if (!document.getElementById(`${nick}`)) {
        var item = document.createElement('li');
        var name = document.createElement('div');
        name.textContent = `Você`;
        var status = document.createElement('div');
        status.className = 'statuscircle'
        status.setAttribute('id', `${nick}`)
        status.style.backgroundColor = 'green';
        item.appendChild(status)
        item.appendChild(name)
        members.appendChild(item)

        var item = document.createElement('option');
        item.setAttribute('id', `all`)
        item.setAttribute('value', `Todos`)
        item.textContent = `Todos`
        online.appendChild(item)
      }

      msg.map(member => {
        if (nick !== member.nick && !document.getElementById(`${member.nick}`)) {
          var item = document.createElement('li');
          var name = document.createElement('div');
          name.textContent = nick === member.nick ? `Você` : `${member.nick}`;
          var status = document.createElement('div');
          status.className = 'statuscircle'
          status.setAttribute('id', `${member.nick}`)
          status.style.backgroundColor = member.online ? 'green' : 'red';
          item.appendChild(status)
          item.appendChild(name)
          members.appendChild(item)
        } else {
          member.online ? document.getElementById(`${member.nick}`).style.backgroundColor = 'green' : document.getElementById(`${member.nick}`).style.backgroundColor = 'red';
        }

        if (nick !== member.nick) {
          if (!document.getElementById(`${member.nick}__status`)) {
            var item = document.createElement('option');
            item.setAttribute('id', `${member.nick}__status`)
            item.setAttribute('value', `${member.nick}`)
            item.disabled = !member.online
            item.textContent = `${member.nick}`
            online.appendChild(item)
          } else {
            const bool = member.online ? true : false
            var status = document.getElementById(`${member.nick}__status`)
            status.disabled = !bool;
          }
        }
      })
    })

    socket.on('typing', (msg) => {
      const nickname = msg.nick === nick ? 'Você' : `${msg.nick}`
      document.getElementById('typing').innerHTML = msg.typing ? `${nickname} está digitando ...` : '';
    });

  </script>
</body>

</html>
